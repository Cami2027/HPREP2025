<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HPREP Volunteer Scheduler</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); }
        .calendar-day { min-height: 120px; }
        .event-dot { width: 8px; height: 8px; border-radius: 50%; }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        /* Modal styles */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .modal-content {
            max-height: 90vh;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Main Container -->
    <div id="app-container" class="container mx-auto p-4 md:p-8">
        
        <!-- Header -->
        <header class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-3xl font-bold text-indigo-600">HPREP Volunteer Scheduler</h1>
                <p class="text-gray-500">Welcome to the central hub for HPREP volunteering.</p>
            </div>
            <div id="auth-links" class="flex items-center space-x-4">
                <button id="login-btn" class="bg-indigo-500 text-white px-4 py-2 rounded-lg hover:bg-indigo-600 transition">Login</button>
                <button id="signup-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition">Sign Up</button>
            </div>
            <div id="user-info" class="hidden items-center space-x-4">
                <span id="user-email" class="font-medium"></span>
                <button id="admin-panel-btn" class="hidden bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 transition">
                    <i class="fas fa-user-shield mr-2"></i>Admin Panel
                </button>
                 <button id="preferences-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition">
                    <i class="fas fa-cog mr-2"></i>Preferences
                </button>
                <button id="logout-btn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition">
                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                </button>
            </div>
        </header>

        <!-- Calendar -->
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <!-- Calendar Header -->
            <div class="flex justify-between items-center mb-4">
                <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-200 transition"><i class="fas fa-chevron-left"></i></button>
                <h2 id="month-year-header" class="text-2xl font-semibold"></h2>
                <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-200 transition"><i class="fas fa-chevron-right"></i></button>
            </div>
            <!-- Calendar Grid -->
            <div class="grid grid-cols-7 gap-px text-center font-semibold text-gray-600 mb-2">
                <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
            </div>
            <div id="calendar-grid" class="calendar-grid border-t border-l border-gray-200">
                <!-- Calendar days will be generated by JavaScript -->
            </div>
        </div>
        
        <!-- Footer with User ID display -->
        <footer class="text-center mt-8 text-gray-500">
            <p>Having issues? Contact the HPREP coordinators.</p>
            <div id="user-id-display" class="mt-2 text-xs text-gray-400"></div>
        </footer>

    </div>

    <!-- Modals -->

    <!-- Auth Modal -->
    <div id="auth-modal" class="modal-backdrop hidden">
        <div class="modal-content bg-white p-8 rounded-xl shadow-2xl w-full max-w-md m-4">
            <h2 id="auth-title" class="text-2xl font-bold mb-6 text-center">Login</h2>
            <div id="auth-error" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-4 hidden" role="alert"></div>
            <form id="auth-form">
                <div class="mb-4">
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="email" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="password" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <button type="submit" id="auth-submit-btn" class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition font-semibold">Login</button>
            </form>
            <button id="close-auth-modal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
        </div>
    </div>

    <!-- Event Detail Modal -->
    <div id="event-modal" class="modal-backdrop hidden">
        <div class="modal-content bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg m-4">
            <h2 id="event-title" class="text-3xl font-bold mb-2"></h2>
            <p id="event-date" class="text-gray-500 mb-4"></p>
            <p id="event-description" class="mb-6"></p>
            
            <div class="bg-gray-100 p-4 rounded-lg mb-6">
                <h3 class="font-semibold text-lg mb-2">Shift Details</h3>
                <p><i class="fas fa-clock mr-2 text-indigo-500"></i><span id="event-time"></span></p>
                <p><i class="fas fa-users mr-2 text-indigo-500"></i><span id="event-slots"></span></p>
            </div>

            <div id="event-signup-section">
                <h4 class="font-semibold mb-2">Signed Up Volunteers:</h4>
                <ul id="event-attendees" class="list-disc list-inside mb-4 h-24 overflow-y-auto bg-gray-50 p-2 rounded-md">
                    <!-- Attendees will be listed here -->
                </ul>
                <button id="signup-for-event-btn" class="w-full bg-green-500 text-white py-2 rounded-lg hover:bg-green-600 transition font-semibold">Sign Up for this Shift</button>
                <button id="withdraw-from-event-btn" class="w-full bg-yellow-500 text-white py-2 rounded-lg hover:bg-yellow-600 transition font-semibold mt-2 hidden">Withdraw from this Shift</button>
                <p id="login-prompt" class="text-center mt-4 text-sm text-gray-600">Please <a href="#" id="login-link-from-modal" class="text-indigo-600 hover:underline">login or sign up</a> to volunteer.</p>
            </div>
            
            <button id="close-event-modal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
        </div>
    </div>

    <!-- Admin Modal -->
    <div id="admin-modal" class="modal-backdrop hidden">
        <div class="modal-content bg-white p-8 rounded-xl shadow-2xl w-full max-w-2xl m-4">
            <h2 class="text-2xl font-bold mb-6">Admin Panel: Create New Event</h2>
            <div id="admin-error" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-4 hidden" role="alert"></div>
            <div id="admin-success" class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg relative mb-4 hidden" role="alert"></div>
            <form id="create-event-form">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="event-name-input" class="block text-sm font-medium text-gray-700 mb-1">Event Name</label>
                        <input type="text" id="event-name-input" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label for="event-date-input" class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                        <input type="date" id="event-date-input" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label for="event-time-input" class="block text-sm font-medium text-gray-700 mb-1">Time (e.g., 9:00 AM - 1:00 PM)</label>
                        <input type="text" id="event-time-input" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label for="event-slots-input" class="block text-sm font-medium text-gray-700 mb-1">Volunteers Needed</label>
                        <input type="number" id="event-slots-input" min="1" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                </div>
                <div class="mt-4">
                    <label for="event-desc-input" class="block text-sm font-medium text-gray-700 mb-1">Short Description</label>
                    <textarea id="event-desc-input" rows="3" required class="w-full px-3 py-2 border border-gray-300 rounded-lg"></textarea>
                </div>
                <div class="mt-6 flex justify-end space-x-4">
                    <button type="button" id="close-admin-modal" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 font-semibold">Publish Event</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Preferences Modal -->
    <div id="preferences-modal" class="modal-backdrop hidden">
        <div class="modal-content bg-white p-8 rounded-xl shadow-2xl w-full max-w-md m-4">
            <h2 class="text-2xl font-bold mb-6">Set Your Availability</h2>
            <p class="text-gray-600 mb-4">Select the days you generally prefer to volunteer. This helps organizers plan.</p>
            <div id="preferences-error" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-4 hidden" role="alert"></div>
            <div id="preferences-success" class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg relative mb-4 hidden" role="alert"></div>
            <form id="preferences-form">
                <div class="grid grid-cols-3 sm:grid-cols-4 gap-4">
                    <!-- Checkboxes will be generated here -->
                </div>
                <div class="mt-6 flex justify-end space-x-4">
                    <button type="button" id="close-preferences-modal" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 font-semibold">Save Preferences</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        // IMPORTANT: Replace with your Firebase project's configuration

    const firebaseConfig = {

    apiKey: "AIzaSyAUsJ7hhDzMwAjSXRa--7_DhJOZF2ev33s",

    authDomain: "ysmhprep2025.firebaseapp.com",

    projectId: "ysmhprep2025",

    storageBucket: "ysmhprep2025.firebasestorage.app",

    messagingSenderId: "901029891531",

    appId: "1:901029891531:web:3c9572a098a3a4b0633a4e",

    measurementId: "G-NCTPN1DDF9"

};
        
        // Use provided config if available (for Canvas environment)
        const finalFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfig;
        
        // Check if the placeholder config is still being used
        if (finalFirebaseConfig.apiKey === "YOUR_API_KEY") {
            document.body.innerHTML = `
                <div class="h-screen w-screen flex justify-center items-center bg-red-100">
                    <div class="text-center p-8 bg-white rounded-lg shadow-xl">
                        <h1 class="text-2xl font-bold text-red-700">Configuration Needed</h1>
                        <p class="mt-2 text-gray-600">This application requires Firebase to function. Please replace the placeholder Firebase configuration in the HTML source code with your own project's configuration.</p>
                    </div>
                </div>
            `;
            // Stop script execution if not configured
            throw new Error("Firebase config not set.");
        }

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged,
            signInWithCustomToken,
            signInAnonymously
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            addDoc, 
            getDoc, 
            setDoc, 
            onSnapshot, 
            updateDoc, 
            arrayUnion, 
            arrayRemove 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- App Initialization ---
        const app = initializeApp(finalFirebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- App ID for Firestore paths ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'hprep-scheduler-default';
        
        // --- Admin Configuration ---
        // To make a user an admin, add their UID (from Firebase Authentication) to this array.
        const ADMIN_UIDS = ["REPLACE_WITH_YOUR_ADMIN_UID"]; 

        // --- State Variables ---
        let currentDate = new Date();
        let events = [];
        let currentUser = null;
        let currentUserRole = 'user';
        let isAuthReady = false;

        // --- DOM Elements ---
        const calendarGrid = document.getElementById('calendar-grid');
        const monthYearHeader = document.getElementById('month-year-header');
        const authLinks = document.getElementById('auth-links');
        const userInfo = document.getElementById('user-info');
        const userEmailSpan = document.getElementById('user-email');
        const adminPanelBtn = document.getElementById('admin-panel-btn');
        const userIdDisplay = document.getElementById('user-id-display');

        // --- Calendar Logic ---
        function renderCalendar() {
            calendarGrid.innerHTML = '';
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            monthYearHeader.textContent = `${currentDate.toLocaleString('default', { month: 'long' })} ${year}`;

            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // Add empty cells for days before the 1st
            for (let i = 0; i < firstDayOfMonth; i++) {
                calendarGrid.innerHTML += `<div class="border-b border-r border-gray-200 bg-gray-50"></div>`;
            }

            // Add day cells
            for (let day = 1; day <= daysInMonth; day++) {
                const dayDate = new Date(year, month, day);
                const dateString = dayDate.toISOString().split('T')[0]; // YYYY-MM-DD
                const dayEvents = events.filter(e => e.date === dateString);

                let eventHtml = '';
                if (dayEvents.length > 0) {
                    eventHtml = `<div class="mt-1 flex flex-wrap justify-center gap-1">`;
                    dayEvents.forEach(event => {
                        const isFull = event.attendees.length >= event.slots;
                        const color = isFull ? 'bg-red-400' : 'bg-indigo-400';
                        eventHtml += `<div class="event-dot ${color}" title="${event.name}"></div>`;
                    });
                    eventHtml += `</div>`;
                }

                const isToday = dayDate.toDateString() === new Date().toDateString();
                const todayClass = isToday ? 'bg-indigo-100' : '';

                const dayCell = document.createElement('div');
                dayCell.className = `calendar-day p-2 border-b border-r border-gray-200 flex flex-col cursor-pointer hover:bg-gray-100 transition ${todayClass}`;
                dayCell.innerHTML = `
                    <div class="font-medium">${day}</div>
                    ${eventHtml}
                `;
                dayCell.addEventListener('click', () => showEventModalForDate(dateString));
                calendarGrid.appendChild(dayCell);
            }
        }
        
        // --- Modal Management ---
        const modals = {
            auth: document.getElementById('auth-modal'),
            event: document.getElementById('event-modal'),
            admin: document.getElementById('admin-modal'),
            preferences: document.getElementById('preferences-modal'),
        };

        function showModal(modalName) {
            Object.values(modals).forEach(m => m.classList.add('hidden'));
            if (modals[modalName]) {
                modals[modalName].classList.remove('hidden');
            }
        }

        function hideAllModals() {
            Object.values(modals).forEach(m => m.classList.add('hidden'));
        }

        // --- Event Listeners for Buttons ---
        document.getElementById('prev-month-btn').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        });

        document.getElementById('next-month-btn').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        });
        
        document.getElementById('login-btn').addEventListener('click', () => {
            document.getElementById('auth-title').textContent = 'Login';
            document.getElementById('auth-submit-btn').textContent = 'Login';
            document.getElementById('auth-form').dataset.mode = 'login';
            showModal('auth');
        });

        document.getElementById('signup-btn').addEventListener('click', () => {
            document.getElementById('auth-title').textContent = 'Sign Up';
            document.getElementById('auth-submit-btn').textContent = 'Sign Up';
            document.getElementById('auth-form').dataset.mode = 'signup';
            showModal('auth');
        });

        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
        
        document.getElementById('admin-panel-btn').addEventListener('click', () => showModal('admin'));
        
        document.getElementById('preferences-btn').addEventListener('click', () => {
            loadUserPreferences();
            showModal('preferences');
        });

        document.getElementById('close-auth-modal').addEventListener('click', hideAllModals);
        document.getElementById('close-event-modal').addEventListener('click', hideAllModals);
        document.getElementById('close-admin-modal').addEventListener('click', hideAllModals);
        document.getElementById('close-preferences-modal').addEventListener('click', hideAllModals);

        // --- Authentication Logic ---
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            isAuthReady = true;
            if (user) {
                // User is signed in
                authLinks.classList.add('hidden');
                userInfo.classList.remove('hidden');
                userInfo.classList.add('flex');
                userEmailSpan.textContent = user.email || 'Anonymous User';
                userIdDisplay.textContent = `User ID: ${user.uid}`;

                // Check for admin role
                const userDocRef = doc(db, `artifacts/${appId}/users`, user.uid);
                const userDoc = await getDoc(userDocRef);
                
                if (userDoc.exists() && userDoc.data().role === 'admin') {
                    currentUserRole = 'admin';
                    adminPanelBtn.classList.remove('hidden');
                } else if (ADMIN_UIDS.includes(user.uid)) {
                    // If user is in the hardcoded list, promote them to admin
                    await setDoc(userDocRef, { email: user.email, role: 'admin' }, { merge: true });
                    currentUserRole = 'admin';
                    adminPanelBtn.classList.remove('hidden');
                } else {
                    currentUserRole = 'user';
                    adminPanelBtn.classList.add('hidden');
                }

            } else {
                // User is signed out
                authLinks.classList.remove('hidden');
                userInfo.classList.add('hidden');
                userInfo.classList.remove('flex');
                userEmailSpan.textContent = '';
                adminPanelBtn.classList.add('hidden');
                currentUserRole = 'user';
                userIdDisplay.textContent = 'Not logged in.';
            }
            // Re-render calendar to update views based on login state
            renderCalendar(); 
        });

        document.getElementById('auth-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const mode = e.target.dataset.mode;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('auth-error');
            errorDiv.classList.add('hidden');

            try {
                if (mode === 'signup') {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    // Create a user document in Firestore
                    const userDocRef = doc(db, `artifacts/${appId}/users`, userCredential.user.uid);
                    await setDoc(userDocRef, {
                        email: email,
                        role: 'user', // Default role
                        preferences: []
                    });
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                }
                hideAllModals();
                e.target.reset();
            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('hidden');
            }
        });
        
        // --- Event Modal Logic ---
        let activeEventId = null;

        function showEventModalForDate(dateString) {
            const dayEvents = events.filter(e => e.date === dateString);
            if (dayEvents.length === 0) {
                // For now, do nothing if no event. Could add a "No events today" message.
                return;
            }
            
            // For simplicity, we'll show the first event of the day.
            // A more complex UI could list multiple events.
            const event = dayEvents[0];
            activeEventId = event.id;

            document.getElementById('event-title').textContent = event.name;
            const eventDate = new Date(event.date + 'T00:00:00');
            document.getElementById('event-date').textContent = eventDate.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('event-description').textContent = event.description;
            document.getElementById('event-time').textContent = event.time;
            
            const slotsFilled = event.attendees.length;
            document.getElementById('event-slots').textContent = `${slotsFilled} / ${event.slots} volunteers`;

            const attendeesList = document.getElementById('event-attendees');
            attendeesList.innerHTML = '';
            if (slotsFilled > 0) {
                 event.attendees.forEach(attendee => {
                    const li = document.createElement('li');
                    li.textContent = attendee.email.split('@')[0]; // Show part of email for privacy
                    attendeesList.appendChild(li);
                });
            } else {
                attendeesList.innerHTML = '<li>No one signed up yet. Be the first!</li>';
            }

            const signupSection = document.getElementById('event-signup-section');
            const loginPrompt = document.getElementById('login-prompt');
            const signupBtn = document.getElementById('signup-for-event-btn');
            const withdrawBtn = document.getElementById('withdraw-from-event-btn');

            if (currentUser) {
                loginPrompt.classList.add('hidden');
                const isSignedUp = event.attendees.some(a => a.uid === currentUser.uid);
                const isFull = slotsFilled >= event.slots;

                if (isSignedUp) {
                    signupBtn.classList.add('hidden');
                    withdrawBtn.classList.remove('hidden');
                } else {
                    withdrawBtn.classList.add('hidden');
                    signupBtn.classList.remove('hidden');
                    signupBtn.disabled = isFull;
                    signupBtn.textContent = isFull ? 'Shift is Full' : 'Sign Up for this Shift';
                    signupBtn.classList.toggle('bg-gray-400', isFull);
                    signupBtn.classList.toggle('cursor-not-allowed', isFull);
                }
            } else {
                loginPrompt.classList.remove('hidden');
                signupBtn.classList.add('hidden');
                withdrawBtn.classList.add('hidden');
            }

            showModal('event');
        }

        document.getElementById('login-link-from-modal').addEventListener('click', (e) => {
            e.preventDefault();
            hideAllModals();
            document.getElementById('login-btn').click();
        });

        document.getElementById('signup-for-event-btn').addEventListener('click', async () => {
            if (!currentUser || !activeEventId) return;
            const eventRef = doc(db, `artifacts/${appId}/public/data/events`, activeEventId);
            try {
                await updateDoc(eventRef, {
                    attendees: arrayUnion({ uid: currentUser.uid, email: currentUser.email })
                });
                hideAllModals();
            } catch (error) {
                console.error("Error signing up:", error);
                alert("Could not sign up for the event. Please try again.");
            }
        });
        
        document.getElementById('withdraw-from-event-btn').addEventListener('click', async () => {
            if (!currentUser || !activeEventId) return;
            const eventRef = doc(db, `artifacts/${appId}/public/data/events`, activeEventId);
            try {
                await updateDoc(eventRef, {
                    attendees: arrayRemove({ uid: currentUser.uid, email: currentUser.email })
                });
                hideAllModals();
            } catch (error) {
                console.error("Error withdrawing:", error);
                alert("Could not withdraw from the event. Please try again.");
            }
        });


        // --- Admin Panel Logic ---
        document.getElementById('create-event-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (currentUserRole !== 'admin') {
                alert("You do not have permission to perform this action.");
                return;
            }

            const event = {
                name: document.getElementById('event-name-input').value,
                date: document.getElementById('event-date-input').value,
                time: document.getElementById('event-time-input').value,
                slots: parseInt(document.getElementById('event-slots-input').value),
                description: document.getElementById('event-desc-input').value,
                attendees: [],
                createdBy: currentUser.uid
            };
            
            const errorDiv = document.getElementById('admin-error');
            const successDiv = document.getElementById('admin-success');
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');

            try {
                const eventsCollection = collection(db, `artifacts/${appId}/public/data/events`);
                await addDoc(eventsCollection, event);
                
                successDiv.textContent = 'Event created successfully!';
                successDiv.classList.remove('hidden');
                e.target.reset();
                
                setTimeout(() => {
                    successDiv.classList.add('hidden');
                    hideAllModals();
                }, 2000);

            } catch (error) {
                console.error("Error creating event:", error);
                errorDiv.textContent = `Error: ${error.message}`;
                errorDiv.classList.remove('hidden');
            }
        });

        // --- Preferences Logic ---
        const daysOfWeek = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        const preferencesForm = document.getElementById('preferences-form');
        const preferencesGrid = preferencesForm.querySelector('.grid');

        daysOfWeek.forEach(day => {
            preferencesGrid.innerHTML += `
                <div class="flex items-center">
                    <input id="pref-${day}" name="preference" type="checkbox" value="${day}" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                    <label for="pref-${day}" class="ml-2 block text-sm text-gray-900">${day}</label>
                </div>
            `;
        });
        
        async function loadUserPreferences() {
            if (!currentUser) return;
            const userDocRef = doc(db, `artifacts/${appId}/users`, currentUser.uid);
            const userDoc = await getDoc(userDocRef);
            if (userDoc.exists() && userDoc.data().preferences) {
                const prefs = userDoc.data().preferences;
                daysOfWeek.forEach(day => {
                    document.getElementById(`pref-${day}`).checked = prefs.includes(day);
                });
            }
        }

        document.getElementById('preferences-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) return;

            const selectedPrefs = Array.from(document.querySelectorAll('input[name="preference"]:checked')).map(cb => cb.value);
            const userDocRef = doc(db, `artifacts/${appId}/users`, currentUser.uid);
            
            const errorDiv = document.getElementById('preferences-error');
            const successDiv = document.getElementById('preferences-success');
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');

            try {
                await setDoc(userDocRef, { preferences: selectedPrefs }, { merge: true });
                successDiv.textContent = 'Preferences saved!';
                successDiv.classList.remove('hidden');
                setTimeout(() => {
                    successDiv.classList.add('hidden');
                    hideAllModals();
                }, 1500);
            } catch (error) {
                console.error("Error saving preferences:", error);
                errorDiv.textContent = `Error: ${error.message}`;
                errorDiv.classList.remove('hidden');
            }
        });


        // --- Firestore Data Fetching ---
        function listenForEvents() {
            const eventsCollection = collection(db, `artifacts/${appId}/public/data/events`);
            onSnapshot(eventsCollection, (snapshot) => {
                events = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderCalendar();
            }, (error) => {
                console.error("Error fetching events:", error);
            });
        }

        // --- Initial Load ---
        async function initializeAppAsync() {
            // Sign in with custom token if provided, otherwise sign in anonymously
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication failed:", error);
            }
            
            // Now that auth state is likely settled, listen for events
            listenForEvents();
        }

        initializeAppAsync();

    </script>
</body>
</html>
